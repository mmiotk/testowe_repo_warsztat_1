name: Warunkowe zależności między zadaniami
on: [push, pull_request]

jobs:
  tests:
    runs-on: ubuntu-latest
    outputs:
      tests-passed: ${{ steps.test-step.conclusion == 'success' }}
    steps:
      - id: test-step
        name: Uruchom testy
        run: |
          echo "Uruchamianie testów..."
          # Symulacja testów - czasem się nie udają
          if [ "${{ github.ref_name }}" == "main" ]; then
            echo "Testy na main zawsze przechodzą"
            exit 0
          else
            echo "Testy na innych gałęziach mogą się nie udać"
            exit 0  # Zmień na 1 aby symulować niepowodzenie
          fi

  build:
    needs: tests
    # Uruchom tylko jeśli testy przeszły pomyślnie
    if: needs.tests.outputs.tests-passed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Buduj aplikację
        run: echo "Budowanie po pomyślnych testach"

  deploy-staging:
    needs: [tests, build]
    # Wdróż na staging tylko dla PR, ale tylko jeśli build był udany
    if: github.event_name == 'pull_request' && needs.build.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Wdrożenie na staging
        run: echo "Wdrażanie PR na środowisko staging"

  deploy-production:
    needs: [tests, build]
    # Wdróż na produkcję tylko dla main, ale tylko jeśli wszystko przeszło
    if: |
      github.ref == 'refs/heads/main' && 
      needs.tests.result == 'success' && 
      needs.build.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Wdrożenie na produkcję
        run: echo "Wdrażanie na produkcję po pełnej walidacji"
