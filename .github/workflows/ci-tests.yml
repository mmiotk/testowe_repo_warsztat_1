name: Zaawansowane zarzÄ…dzanie woluminami
on: [push]

jobs:
  volume_demonstration:
    runs-on: ubuntu-latest
    container:
      image: node:18
      volumes:
        # Cache npm dla przyspieszenia instalacji zaleÅ¼noÅ›ci
        - npm_cache:/root/.npm
        # WspÃ³Å‚dzielenie artefaktÃ³w buildu miÄ™dzy krokami
        - build_output:/app/dist
        # Logi do debugowania (mapowanie z hosta)
        - /tmp/github_actions_logs:/app/logs
        # Tymczasowe pliki robocze
        - workspace:/workspace

    steps:
      - name: Przygotowanie Å›rodowiska i cache
        run: |
          echo "ğŸ“¦ Przygotowanie cache i workspace:"
          
          # SprawdÅº dostÄ™pne woluminy
          echo "DostÄ™pne punkty montowania:"
          mount | grep -E "/root/.npm|/app/dist|/app/logs|/workspace"
          
          # Przygotuj strukturÄ™ katalogÃ³w
          mkdir -p /app/dist /app/logs /workspace/temp
          
          echo "âœ… Åšrodowisko przygotowane"

      - name: Symulacja budowania z wykorzystaniem cache
        run: |
          echo "ğŸ—ï¸ Budowanie aplikacji z cache npm:"
          
          # SprawdÅº czy cache npm istnieje
          if [ -d "/root/.npm" ] && [ "$(ls -A /root/.npm)" ]; then
            echo "âœ… Cache npm znaleziony - przyspieszona instalacja"
            ls -la /root/.npm | head -5
          else
            echo "ğŸ“¥ Cache npm pusty - pierwsza instalacja"
          fi
          
          # Symulacja npm install (ktÃ³ra wykorzysta cache)
          echo "Instalowanie zaleÅ¼noÅ›ci..."
          touch /root/.npm/fake-package-cache
          
          # Symulacja procesu budowania
          echo "Kompilowanie aplikacji..."
          echo "Build output $(date)" > /app/dist/bundle.js
          echo "Source maps $(date)" > /app/dist/bundle.js.map
          
          echo "ğŸ“Š Logi buildu:" > /app/logs/build.log
          echo "Build completed at $(date)" >> /app/logs/build.log

      - name: Weryfikacja artefaktÃ³w i cleanup
        run: |
          echo "ğŸ” Weryfikacja wygenerowanych artefaktÃ³w:"
          
          echo "Pliki w /app/dist:"
          ls -la /app/dist/
          
          echo "ZawartoÅ›Ä‡ bundle.js:"
          cat /app/dist/bundle.js
          
          echo "Logi buildu:"
          cat /app/logs/build.log
          
          echo "ğŸ§¹ Cleanup workspace:"
          rm -rf /workspace/temp/*
          echo "Workspace wyczyszczony, ale dane w /app/dist pozostajÄ… dla kolejnych krokÃ³w"
